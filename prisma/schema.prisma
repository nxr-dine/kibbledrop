// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("STORAGE_DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  phone         String?
  address       String?
  role          String    @default("customer") // customer, admin
  accounts      Account[]
  sessions      Session[]
  petProfiles   PetProfile[]
  subscriptions Subscription[]
  orders        Order[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  cart          Cart?
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PetProfile {
  id          String   @id @default(cuid())
  userId      String
  name        String
  type        String // e.g., Dog, Cat
  breed       String
  birthday    DateTime? // Pet's birthday (temporarily optional for migration)
  weight      Float?
  image       String? // Pet's image URL
  vaccineCardUrl String? // URL (data URL or external) to vaccine card PDF/image
  healthTags  String[] // e.g., ["allergies", "special diet"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  price       Float
  category    String // e.g., Food, Treats, Accessories
  petType     String // Dog or Cat
  image       String
  featured    Boolean  @default(false)
  
  // New filtering fields
  brand       String? // Product brand
  weight      String? // Product weight (e.g., "2kg", "500g") - kept for backward compatibility
  species     String? // Dog or Cat (same as petType but more explicit)
  lifeStage   String? // adult, kitten, puppy, senior
  productType String? // Cat Treat, Dog Treat, Dry Cat Food, etc.
  foodType    String? // dry, wet
  
  // Nutrition Facts
  protein     String?  @default("Min 28%")
  fat         String?  @default("Min 15%")
  fiber       String?  @default("Max 4%")
  moisture    String?  @default("Max 10%")
  calories    String?  @default("3,500 kcal/kg")
  omega6      String?  @default("Min 1.4%")
  
  // Ingredients
  ingredients String?  @default("Deboned chicken as the first ingredient, Sweet potatoes and peas for digestible carbohydrates, Chicken meal and salmon meal for added protein, Flaxseed for omega fatty acids, Blueberries and cranberries for antioxidants, No corn, wheat, soy, or artificial preservatives")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  weightVariants    ProductWeightVariant[]
  subscriptionItems SubscriptionItem[]
  orderItems        OrderItem[]
  cartItems         CartItem[]
}

model ProductWeightVariant {
  id        String  @id @default(cuid())
  productId String
  weight    String  // e.g., "1kg", "2kg", "5kg"
  price     Float   // Price for this specific weight
  inStock   Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, weight])
}

model Subscription {
  id             String   @id @default(cuid())
  userId         String
  petProfileId   String?
  frequency      String // weekly, bi-weekly, monthly
  status         String // active, paused, canceled
  deliveryName   String
  deliveryPhone  String
  deliveryAddress String
  city           String
  postalCode     String
  instructions   String?
  stripeCustomerId String?
  stripeSubscriptionId String?
  nextDelivery   DateTime?
  skippedDeliveries String[] // Array of skipped delivery dates
  customDeliveryDate DateTime? // Custom delivery date if different from calculated
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet  PetProfile? @relation(fields: [petProfileId], references: [id], onDelete: Cascade)
  items SubscriptionItem[]
}

model SubscriptionItem {
  id             String   @id @default(cuid())
  subscriptionId String
  productId      String
  quantity       Int
  createdAt      DateTime @default(now())
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id                String   @id @default(cuid())
  userId            String
  status            String   // pending, processing, shipped, delivered, canceled
  subtotal          Float
  shipping          Float
  total             Float
  deliveryName      String
  deliveryPhone     String
  deliveryAddress   String
  city              String
  postalCode        String
  instructions      String?
  deliveryMethod    String   // standard, express
  trackingNumber    String?
  estimatedDelivery DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
}

model Trade {
  id          String   @id @default(cuid())
  tradeId     String   @unique // TradeSafe transaction ID
  status      String   @default("CREATED") // CREATED, FUNDS_RECEIVED, COMPLETED, CANCELLED, REFUNDED
  buyerEmail  String
  sellerEmail String
  amount      Float?   // Trade amount in cents
  currency    String   @default("ZAR")
  title       String?  // Trade title/description
  reference   String?  // TradeSafe reference
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tradeId])
  @@index([status])
}
